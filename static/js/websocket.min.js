!(function (window) {
    window.WebSocketAdress = function(address) {
        let loc = window.location;
        let wsStart = 'ws://';
        
        if (loc.protocol == 'https:') {
            wsStart = 'wss://';
        }
        
        return wsStart + loc.host + address;
    }
    
    window.WebSocketHandler = function(url, onMessageCallback, onOpenCallback, onCloseCallback, onErrorCallback) {
        // Create WebSocket connection
        let socket = new WebSocket(url);
        
        // Connection opened
        socket.addEventListener('open', function(event) {
            if (typeof onOpenCallback === 'function') {
                onOpenCallback(event);
            }
        });
        
        // Listen for messages
        socket.addEventListener('message', function(event) {
            if (typeof onMessageCallback === 'function') {
                onMessageCallback(event);
            }
        });
        
        // Connection closed
        socket.addEventListener('close', function(event) {
            if (typeof onCloseCallback === 'function') {
                onCloseCallback(event);
            }
        });
        
        // Error handler
        socket.addEventListener('error', function(event) {
            if (typeof onErrorCallback === 'function') {
                onErrorCallback(event);
            }
        });

        return {
            // Add methods to send and close connection
            send: function(data) {
                if (socket.readyState === WebSocket.OPEN) {
                    socket.send(JSON.stringify(data));
                } else {
                    console.error("Cannot send data, WebSocket is not in the OPEN state");
                }
            },
            close: function() {
                if (socket.readyState === WebSocket.OPEN || socket.readyState === WebSocket.CONNECTING) {
                    socket.close();
                } else {
                    console.error("Cannot close WebSocket, it is already closing or closed");
                }
            },
            getReadyState: function() {
                return socket.readyState;
            }
        }
    }
})(window);
